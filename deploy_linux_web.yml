---
# ====================================================
# [1ë‹¨ê³„] vCenterì— ì ‘ì†í•˜ì—¬ Linux(CentOS) VM ìƒì„±í•˜ê¸°
# ====================================================
- name: 1. Linux Service Provisioning Phase
  hosts: localhost
  gather_facts: no
  vars:
    # [ì„¤ì •] vCenter ì ‘ì† ì •ë³´
    vcenter_hostname: "192.168.0.100"
    vcenter_username: "administrator@vsphere.local"
    vcenter_password: "YourVcenterPassword!"
    
    # [ê¸°ë³¸ê°’ ì„¤ì •] íŒŒì´ì¬ì—ì„œ ê°’ì„ ì•ˆ ì£¼ë©´ ì•„ë˜ ê°’ì„ ì“°ì§€ë§Œ, ì‹¤ì œë¡  íŒŒì´ì¬ì´ ë®ì–´ì”Œì›€
    # {{ ... }} êµ¬ë¬¸ì´ íŒŒì´ì¬ì—ì„œ ë„˜ì–´ì˜¨ ë³€ìˆ˜ë¥¼ ë°›ëŠ” ìë¦¬ì…ë‹ˆë‹¤.
    vm_template: "CentOS7-Template-v1"
    vm_name: "{{ target_vm_name | default('Web-Service-Default') }}"
    vm_ip: "{{ target_vm_ip | default('192.168.0.202') }}"
    vm_gateway: "192.168.0.1"
    vm_dns: "8.8.8.8"
    root_password: "Password123!"

  tasks:
    - name: Clone Linux VM from Template
      vmware_guest:
        hostname: "{{ vcenter_hostname }}"
        username: "{{ vcenter_username }}"
        password: "{{ vcenter_password }}"
        validate_certs: no
        datacenter: "Datacenter"
        cluster: "Cluster01"
        datastore: "Datastore01"
        folder: "/"
        name: "{{ vm_name }}"
        template: "{{ vm_template }}"
        state: poweredon
        
        # [ë„¤íŠ¸ì›Œí¬ ì„¤ì •]
        networks:
          - name: "VM Network"
            ip: "{{ vm_ip }}"
            netmask: "255.255.255.0"
            gateway: "{{ vm_gateway }}"
        
        # [Customization] í˜¸ìŠ¤íŠ¸ë„¤ì„ ë° DNS ì„¤ì •
        customization:
          hostname: "{{ vm_name }}"
          dns_servers:
            - "{{ vm_dns }}"
        
        wait_for_ip_address: yes
      delegate_to: localhost
      register: deploy_vm

    - name: Add new host to inventory (ë©”ëª¨ë¦¬ì— ì„ì‹œ ë“±ë¡)
      add_host:
        hostname: "{{ vm_ip }}"
        groups: linux_new
        ansible_user: root
        ansible_password: "{{ root_password }}"
        ansible_ssh_common_args: '-o StrictHostKeyChecking=no'

# ====================================================
# [2ë‹¨ê³„] ìƒì„±ëœ ë¦¬ëˆ…ìŠ¤ì— ì ‘ì†í•˜ì—¬ Nginx ì›¹ì„œë²„ ì„¤ì¹˜
# ====================================================
- name: 2. Service Configuration Phase (Nginx)
  hosts: linux_new
  gather_facts: no
  
  tasks:
    - name: Wait for SSH connection
      wait_for_connection:
        timeout: 300

    - name: Install EPEL Repo
      yum:
        name: epel-release
        state: present

    - name: Install Nginx Web Server
      yum:
        name: nginx
        state: present

    - name: Create Custom Index Page
      copy:
        dest: /usr/share/nginx/html/index.html
        content: |
          <html>
          <body style="background-color:black; color:white; text-align:center; padding-top:100px;">
            <h1>ğŸš€ H-CMP Automation Success!</h1>
            <h2>Service: {{ vm_name }}</h2>
            <p>Deployed by Ansible & Python</p>
          </body>
          </html>          

    - name: Start & Enable Nginx Service
      service:
        name: nginx
        state: started
        enabled: yes

    - name: Open Firewall Port 80
      firewalld:
        service: http
        permanent: yes
        state: enabled
        immediate: yes