# H-CMP 백엔드 작업 보고서

**작성 목적:** 지금까지 수행한 FastAPI 백엔드 작업 내역을 보고서 형식으로 정리  
**대상 프로젝트:** public_version_(2)  
**기술 스택:** FastAPI, SQLAlchemy, PostgreSQL / SQLite, Mock Runner

---

## 1. 개요

| 항목 | 내용 |
|------|------|
| 작업 범위 | 프로비저닝 비동기화(Mock Runner), DB 연결 폴백, 첫 화면 라우팅 변경, 하드코딩 정리, main_ui 통합, configure 페이지 단순화 |
| 원칙 | 기존 API/라우트/응답 형태 유지, DB 모델 최소 수정, 템플릿은 필요한 부분만 수정 |
| 결과 | 로컬에서 DB 없이도 실행 가능, UI에서 Start Provisioning → History/Monitoring 연동, omakase 로그인 후 main_ui.html로 진입 |

---

## 2. 배경 및 목표

- **배경:** 실제 vCenter/Ansible 정보가 준비되기 전에, 하드코딩 기반으로라도 UI와 백엔드가 먼저 동작해야 함. 이후 Real Runner(Ansible 등)로 교체할 수 있는 구조가 필요함.
- **목표**
  - POST /api/provision 호출 시 즉시 응답 후, 백그라운드에서 Mock 프로비저닝 실행
  - 상태/로그/리소스 결과를 DB(details JSON)에 저장
  - History·Monitoring API/화면에서 해당 데이터 확인 가능
  - DB 연결 실패 시에도 앱이 죽지 않고 SQLite로 폴백하여 로컬 실행 가능
  - 첫 화면을 인프라 선택 페이지로 변경하고, AWS 선택 시 Configure 페이지로 이동

---

## 3. 작업 내역 요약

### 3.1 Mock Runner 및 비동기 프로비저닝

- **내용:** POST /api/provision 을 “즉시 응답 + 백그라운드 Mock 실행” 방식으로 변경.
- **동작**
  1. 요청 수신 시 DB에 `ProjectHistory` 레코드 생성 (status=PENDING, details에 input/config/infra/logs/resources/error 구조 저장).
  2. `BackgroundTasks`로 `run_mock_provisioning_task(project_id, input_spec)` 실행.
  3. Mock Runner가 단계별 로그를 쌓고, 가짜 리소스(alb_ip, web_url, db_vip, ssh_targets)를 생성한 뒤 `details`와 `ProjectHistory.status`·`assigned_ip`를 RUNNING → COMPLETED/FAILED 로 갱신.
- **구조:** `config.py`(설정), `services/provisioner.py`(상태·details 갱신), `services/runners/mock_runner.py`(Mock 실행)로 분리하여, 추후 Real Runner로 교체 가능하도록 인터페이스 유지.

### 3.2 DB 연결 폴백 (로컬 무조건 실행 가능)

- **내용:** PostgreSQL(하드코딩 URL) 연결 실패 시 SQLite(`sqlite:///./app.db`)로 자동 전환.
- **구현**
  - `_create_engine_with_fallback()`: 먼저 PostgreSQL로 `engine.connect()` 시도, 실패 시 예외의 host/port/사유를 로그에 출력하고 `"DB 연결 실패 → SQLite로 임시 전환"` 콘솔 메시지 후 SQLite 엔진 반환.
  - 하드코딩된 PostgreSQL URL은 그대로 유지하고, 폴백 시에만 SQLite 사용.
- **효과:** 로컬에 PostgreSQL이 없어도 앱이 시작 단계에서 종료되지 않음.

### 3.3 SQLAlchemy 2.0 대응 및 하드코딩 정리

- **SQLAlchemy:** `from sqlalchemy.ext.declarative import declarative_base` → `from sqlalchemy.orm import declarative_base` 로 변경하여 MovedIn20Warning 제거.
- **하드코딩 경계:** 다음 구간에 `# HARDCODED CONFIG START` / `# HARDCODED CONFIG END` 및 필요 시 `TODO: 나중에 실제 … 로 교체` 주석 추가.
  - 암호화 키 (ENCRYPT_KEY)
  - DB URL (SQLALCHEMY_DATABASE_URL, SQLITE_FALLBACK_URL)
  - Prometheus URL (query_prometheus 내부)
- **원칙:** 하드코딩 값을 삭제하지 않고 유지하며, 나중에 실제 vCenter/AWS/DB 정보로 교체하기 쉽게 표시.

### 3.4 첫 화면 흐름 변경

- **변경 전:** `GET /` → `omakase_final.html` (Configure & Provision).
- **변경 후**
  - `GET /` → `select_infra(1).html` (인프라 선택).
  - `GET /configure` → `omakase_final.html` (Configure & Provision).
  - `templates/select_infra(1).html` 의 “Public Cloud - AWS” 카드 링크를 `/aws-console` → `/configure` 로 변경.
- **템플릿 경로:** 작업 디렉터리 영향 없이 동작하도록 `main.py` 기준 절대 경로 `_TEMPLATES_DIR` 를 두고, 모든 페이지 라우트에서 `FileResponse(os.path.join(_TEMPLATES_DIR, "파일명"))` 사용.

### 3.5 main_ui 통합 (main_ui(3).html 제거)

- **배경:** 팀 합의로 `main_ui(3).html` 제거, `main_ui.html`을 정식 파일로 사용.
- **진행 내용**
  1. **main.py:** `GET /main_ui` 라우트 추가 → `main_ui.html` 반환 (라우트 기반 접근 통일).
  2. **templates/main_ui(3).html:** 파일 삭제. 프로젝트 내 해당 파일 참조는 없었음.
  3. **templates/monitoring.html:** 기존 `location.href='/main_ui'` 유지 (Expert 버튼 → /main_ui).
  4. **main_ui 관련 주석 정리:** main.py docstring에서 “(정식)” 등 main_ui(3) 대비 표현 제거, 문서에서 main_ui(3) 언급 삭제.
- **역할:** 로그인 후 콘솔/Expert Mode 화면은 모두 `main_ui.html`(/main_ui)로 통일.

### 3.6 omakase_final(configure) → main_ui 흐름 및 페이지 단순화

- **로그인 후 이동:** omakase_final.html에서 “프로젝트 생성하기” → 로그인 모달 → 로그인 성공 시 `window.location.href = '/main_ui'` 로 이동하도록 수정. (기존에는 같은 페이지 내 대시보드 표시.)
- **configure 페이지 단순화:** 예전 main_ui(3) 역할이던 인라인 대시보드 제거.
  - **제거한 HTML:** `settings-modal`(Preferences), `dashboard-page` 전체(Management Console, Step 1~4, 템플릿 선택, CloudFormation 콘솔 패널 등).
  - **제거한 스크립트:** `showDashboard`, `checkSession`, `startSessionTimer`, `extendSession`, `logout`, 설정 모달/대시보드 전용 함수, `validateName`, `renderPackageGrid`, `applyTemplate`, `startProvision`, `runCloudFormationSimulation` 등 대시보드·프로비저닝 UI 관련 로직 전부.
- **유지한 내용:** 랜딩(“Build your architecture in seconds”, 프로젝트 생성하기 버튼), 로그인 모달, `tryLogin`(성공 시 `/main_ui` 이동).
- **결과:** `/configure` 접속 시 랜딩 + 로그인만 노출되고, 로그인 성공 시 바로 main_ui.html(/main_ui)로 이동.

---

## 4. 시스템 구조

### 4.1 프로비저닝 흐름 (Mock)

```
[UI] Start Provisioning
    → POST /api/provision
    → main.py: ProjectHistory 생성 (PENDING, details 초기화)
    → 즉시 응답 { status, message, project_id }
    → BackgroundTasks: run_mock_provisioning_task(project_id, input_spec)
        → mock_runner: 단계별 로그 + 가짜 리소스 생성
        → provisioner.update_provision_status(): details + status/assigned_ip 갱신
    → GET /api/history, GET /api/monitoring/my-resources 에서 반영
```

### 4.2 페이지 라우팅

```
GET /              → select_infra(1).html (인프라 선택)
GET /configure     → omakase_final.html (Configure: 랜딩 + 로그인, 성공 시 /main_ui 이동)
GET /main_ui       → main_ui.html (로그인 후 콘솔 / Expert Mode)
GET /history       → history.html
GET /monitoring    → monitoring.html
```

### 4.3 페이지 흐름 (사용자 관점)

```
/ (인프라 선택)
  ├─ [Public Cloud - AWS] → /configure (omakase_final)
  │     → 프로젝트 생성하기 클릭 → 로그인 모달 → 로그인 성공 → /main_ui (main_ui.html)
  └─ [Private Cloud - vSphere] → /private-console

/monitoring → [Expert 버튼] → /main_ui (main_ui.html)
```

### 4.4 details 스키마 (ProjectHistory.details JSON)

```json
{
  "input": { "serviceName", "userName", "config", "targetInfra" },
  "config": { ... },
  "infra": { ... },
  "status": "PENDING | RUNNING | COMPLETED | FAILED",
  "logs": [ "Allocating IP...", "Creating Web tier...", ... ],
  "resources": { "alb_ip", "web_url", "db_vip", "ssh_targets": [...] },
  "error": { "message": "..." }
}
```

---

## 5. API 정리 (기존 유지 + 확장)

| 메서드 | 경로 | 설명 | 비고 |
|--------|------|------|------|
| POST | /api/login | 로그인 | 기존 유지 |
| GET | /api/public/settings | 공개 설정 | 기존 유지 |
| POST | /api/provision | 프로비저닝 시작 | 즉시 응답 + 백그라운드 Mock, project_id 반환 |
| GET | /api/history | 프로젝트 히스토리 목록 | 기존 유지, details에 status/logs/resources 반영 |
| DELETE | /api/provision/{id} | 프로젝트 삭제 | 기존 유지 |
| GET | /api/monitoring/my-resources | 내 리소스 목록 | WorkloadTestPool + Mock details.resources 병합 반환 |

---

## 6. 파일 구성

### 6.1 신규·수정된 파일

| 파일 | 구분 | 역할 |
|------|------|------|
| main.py | 수정 | 라우팅, DB 폴백, Mock 프로비저닝 호출, 페이지 경로(_TEMPLATES_DIR), HARDCODED 경계 |
| config.py | 신규 | 템플릿 매핑, Mock IP/URL/로그 단계/상태값 등 CONFIG 딕셔너리 |
| services/__init__.py | 신규 | 패키지 초기화 |
| services/provisioner.py | 신규 | update_provision_status(상태·로그·리소스·에러 저장), get_project_details |
| services/runners/__init__.py | 신규 | 패키지 초기화 |
| services/runners/mock_runner.py | 신규 | run_mock_provisioning_async, run_mock_provisioning_task (Mock 실행) |
| templates/select_infra(1).html | 수정 | AWS 카드 href: /aws-console → /configure |
| templates/main_ui.html | 사용 | GET /main_ui 로 서빙 (omakase 로그인 후·Monitoring Expert) |
| templates/omakase_final.html | 수정 | 로그인 성공 시 /main_ui 리다이렉트; 대시보드·설정 모달·관련 JS 제거(configure 단순화) |
| 실행및테스트방법.md | 신규 | 실행·테스트 절차 정리 |
| 백엔드_작업_보고서.md | 신규 | 본 보고서 |

### 6.2 삭제된 파일

| 파일 | 비고 |
|------|------|
| templates/main_ui(3).html | 제거. main_ui.html로 통합, 참조처 없음. |

### 6.3 수정하지 않은 파일

- 기존 API 로직, DB 모델(테이블/컬럼), templates 내 history.html, monitoring.html 등. (omakase_final.html은 configure 단순화 목적으로 수정됨.)

---

## 7. 실행 및 확인 방법

1. **의존성 설치:** `pip install -r requirements.txt` (필요 시 `pip install cryptography`)
2. **서버 실행:** `python main.py` (또는 `uvicorn main:app --host 0.0.0.0 --port 8000`)
3. **동작 확인**
   - http://localhost:8000/ → 인프라 선택 페이지(select_infra(1).html)
   - “Public Cloud - AWS” 클릭 → http://localhost:8000/configure (omakase_final: 랜딩 + 로그인)
   - 로그인(예: admin / 설정 비밀번호) 성공 → http://localhost:8000/main_ui (main_ui.html) 이동 확인
   - Monitoring 페이지에서 Expert 버튼 → /main_ui 이동 확인
   - Provisioning 실행 후 /api/history, /api/monitoring/my-resources 에서 상태·리소스 확인
4. **DB 폴백:** PostgreSQL 연결 실패 시 콘솔에 “DB 연결 실패 → SQLite로 임시 전환” 출력 후 `app.db`(SQLite)로 동작

자세한 단계는 `실행및테스트방법.md` 참고.

---

## 8. 향후 교체·확장 포인트 (TODO)

- **DB:** `main.py` 내 HARDCODED CONFIG 구간의 `SQLALCHEMY_DATABASE_URL` 을 실제 운영 DB 정보로 교체.
- **Prometheus:** `query_prometheus()` 내 `PROMETHEUS_URL` 을 실제 Prometheus 주소로 교체.
- **Runner:** `services/runners/mock_runner.py` 를 Real Runner(Ansible 등)로 교체 시, 동일한 진입점(예: project_id, input_spec 수신)을 유지하면 됨.
- **암호화:** ENCRYPT_KEY 등 암호화 설정을 실제 키/설정으로 교체.

---

## 9. 결론

- Mock Runner 기반 비동기 프로비저닝, DB 폴백, 첫 화면 라우팅 변경, 하드코딩 경계 정리가 적용된 상태이며, 기존 API와 페이지 동작은 유지되었다.
- main_ui(3).html은 제거하고 main_ui.html을 정식으로 사용하며, 로그인 후 콘솔/Expert 화면은 모두 `/main_ui`(main_ui.html)로 통일되었다.
- configure(omakase_final) 페이지는 랜딩 + 로그인만 남기고 예전 인라인 대시보드를 제거하여, 로그인 성공 시 `/main_ui`로 이동하는 흐름으로 단순화되었다.
- 로컬에서 PostgreSQL 없이도 실행 가능하고, History/Monitoring에서 Mock 결과를 확인할 수 있으며, 추후 Real Runner·실제 DB·Prometheus로 교체할 위치가 코드와 주석으로 명확히 표시되어 있다.
